// runs the auth code flow and retrieves user data
Flow agama.inbound.oauth2.authzCodeWithUserInfo
     Basepath ""
     Inputs oauthParams
// launch the oauth code flow
obj = Trigger agama.inbound.oauth2.authzCode oauthParams
// extract access token
token = obj.data.access_token
// calls the userinfo endpoint and parses the request as  a map
p | E = Call io.jans.util.NetworkUtils#mapFromGetRequestWithToken oauthParams.userInfoEndpoint token
// check if exception was thrown previously
When E is not null
     // error log
     Log "@error " E
     // list of error message
     msg = ["Unable to retrieve user profile.", E.message]
     // generate error message
     msg = Call java.lang.String#join " "  msg 
     // fail attempt
     it_mrwce = { success: false, error:  msg}
     Finish it_mrwce
// dump profile data
Log "@debug Profile data:\n" p
// assign response data
obj = { success: true, data: { profile: p, tokenResponse: obj.data } }
// return obj data
Finish obj